# Synchronization
ก่อนที่เราจะเริ่มเข้าเรื่องการทำงานของ Synchronization อันดับแรกอยากจะชวนมารู้จักกับคำศัพท์เล็กๆน้อยๆกันก่อน  

Synchronization หรือ การทำงานร่วมกันของ Threads ต่างๆ
  
Concurrency คือ การประมวลผลการทำงานบนระบบ single-core ซึ่งจะประมวลผลไปทีละ Threads ไปเรื่อยๆ
  
Parallelism คือ การประมวลผลบนระบบ multi-core ซึ่งจะประมวลผลคู่ขนานกัน หรือ ประมวลผลไปพพร้อมกันหลายๆ Threads เพื่อผลลัพธ์การทำงานที่เร็วยิ่งขึ้น  
  
ลองเปรียบเทียบง่ายๆกับการทำเครป ถ้าเรามีเตาแค่เตาเดียวเราก็ทำเครปได้แค่ที่ละแผ่นอยากได้เครปหลายอันก็ต้องทำเรียงกันไปทีละอันถ้าอันที่ทำอยู่ยังไม่เสร็จก็ไม่สามารถทำอันต่อไปได้ แต่ถ้าเรามีเตา 3 เตาละ เราก็จะสามารถทำเครปพร้อมกันได้ทีละ 3 อัน ถ้าอันไหนเสร็จก็เอาออกแล้วเอาอันต่อไปมาทำจนเสร็จทั้งหมด  
  
Mutual exclusion คือ การที่ synchronization นั้นยอมให้มีแค่ thread เดียวเท่านั้นในการใช้งานทรัพยากรร่วมกันในเวลาเดียวกัน
  
Critical section คือ ส่วนของโปรแกรมที่ยอมให้ thread เดียวเท่านั้นทำงานในเวลาเดียวกัน
  
## Lock-Based Synchronization
สมมติว่าเรามีกุญแจที่สามารถล็อคอะไรไว้ก็ได้ ซึ่งกุญแจนี้สามารถทำงานได้ 2 แบบ คือ
1. Lock.Acquire() คือ การรอจนกว่ากุญแจจะปลดล็อค
2. Lock.Release() คือ การปลดล็อคเพื่อให้ Thread อื่นสามารถเข้ามาใช้งานได้
  
สมมติปัญหาการเข้าห้องน้ำ  
``` c++
// Thread A
toiletLock.Acquire();
if (nobody)
	Get in;
toiletLock.Release();

// Thread B
toiletLock.Acquire();
if (nobody)
	Get in;
toiletLock.Release();

```
  
จะอธิบายคร่าวๆได้ว่า เมื่อไม่มีใครอยู่ในห้องน้ำถึงจะสามารถเข้าไปใช้ห้องน้ำห้องนี้ได้ ถ้ามีคนอยู่ก็ต้องรอจนกว่าเขาจะออกมาก่อนถึงจะเข้าได้
  
## Semaphores
Semaphores คือ object อันหนึ่งที่มีค่ามากกว่า หรือ เท่ากับ 0 และมี operations อยู่ 2 อย่าง คือ
1. P() หรือ proberen คือ operation ที่จะรอจนกว่า Semaphore มีค่าเป็นบวก และจะลดค่าของ Semaphore นั้นลงไป 1
2. V() หรือ verhogen คือ operation ที่จะเพิ่มค่าของ Semaphore ไปอีก 1 และไปเรียก operation P() ให้ทำงานถ้า Semaphore มีค่าเท่ากับ 1 หรือ มากกว่านั้น
  
ซึ่งค่าของ Semaphores ไม่สามารถอ่าน หรือ เขียนค่าอะไรใหม่ลงไปได้ เราต้องดำเนินการผ่าน operations P() หรือ V() เท่านั้น
  
กลับไปที่ตัวอย่างเครป สมมติเรามีเตา 2 เตา แต่ต้องการเครป 3 แผ่น เรามาจิตนาการว่ามันคือ Semaphores กัน
1. เซตค่าของ Semaphores (S) เป็น 2 เพื่อเป็นการบอกว่าเรามีเตาสำหรับทำเครป 2 เตา
2. เราทำเครปไป 1 แผ่น เรียกใช้งาน P(); และปรับค่า S = 1
3. เราทำเพิ่มอีก 1 แผ่น เรียกใช้งาน P(); อีกรอบและตอนนี้ค่า S ก็จะโดนลดไปเป็น 0
4. ถ้าเราอยากทำเครปเพิ่มอีกแผ่นแต่พพอมาเช็คดูค่า S ของเราเป็น S อยู่นั้นแปลว่าตอนนี้เราไม่มีเตาสำหรับทำเครปที่ว่างอยู่เลย ดังนั้นจึงยังไม่สามารถเริ่มทำเครปได้
5. แต่พอรอไปอีกสักพักก็มีเครปแผ่นนึงเสร็จและใช้ V() ปล่อยค่า S เพิ่มอีก 1 เป็น 1 แปลว่าตอนนี้เรามีเตาว่างแล้ว
6. พอเตาว่างเครปที่อยู่ในคิวที่จะทำก็จะสามารถเริ่มทำได้ทันที และเรียกใช้งาน P() เพื่อบอกว่าตอนนี้เตานี้ถูกใช้ไปแล้วนะ
7. รอจนกว่าเครปทั้งหมดจะเสร็จ ถ้าเครปแผ่นไหนเสร็จก็จะเรียกใช้ V()
8. พอเครปแต่ละแผ่นเสร็จก็นำมาใส่ถุงรวมกันและให้ลูกค้า
  
ที่นี้เราลองมาเขียนเป็น code กันดูบ้าง
``` c++
Semaphore crapeMaker = 2; // กำหนดค่าว่ามีเตาอยู่ 2 เตา

Cooked() {
	crapeMaker.P(); // เช็คว่ามีเตาว่างไหม และ รอจนกว่าเตาจะว่างถึงทำงานต่อ
	...
	/* เริ่มทำเครป */
    ...
	crapeMaker.V(); // บอกว่าเตาว่างแล้ว
}

```
  
หน้าตาคร่าวๆของ code เราก็จะประมาณนี้

## Reference
Big thank to my instructor's slide Paruj Ratanaworabhan
- [Introduction to Synchronization](https://www.cpe.ku.ac.th/~paruj/219222/synchronization_intro.pdf)
- [Semaphore](https://www.cpe.ku.ac.th/~paruj/219222/semaphore.pdf)